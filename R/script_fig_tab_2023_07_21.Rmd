---
title: "Untitled"
author: "MC"
date: "30/06/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = F}

packages.needed <- c(
  "targets",
  "flextable", 
  "dplyr",
  "ggplot2", 
  "data.table", 
  "stringr",
  "cowplot"
  )

lapply(packages.needed, library, character.only = TRUE)

```


```{r specify directories, include = F}

dir <- "~/R_projects/thesis_simplified" # need to use the absolute path
dir.fig.tab <- "fig_tab" # repertory where graph are saved

# provided online (or can be generated online)
dir.target.store_absolute_analysis <- paste0(dir, "/store_analysis_part1_new")
dir.R.functions <- paste0(dir, "/R/functions")

# not provided online
dir.target.store_absolute_data <- paste0(dir, "/store_data_part1")
dir.data.raw_absolute <- paste0(dir, "/data_prepared/db_species_raw")
dir.data.calibration_absolute <- paste0(dir, "/data_prepared/db_species_inference")


```

```{r useful objects}

tar_load(species_list, store = dir.target.store_absolute_analysis)
tar_load(db_species.name, store = dir.target.store_absolute_analysis)
tar_load(db_stand.number.final, store = dir.target.store_absolute_data)
db_stand.number <- db_stand.number.final

```

# table species studied

```{r speciesstudied, results='asis'}
tar_load(db_description_species, store = dir.target.store_absolute_analysis)

db_description_species_print <- db_description_species[,
    .(name, stand.number, mean.height, sd.height, mean.age, sd.age, min.age, max.age, min.year.origin, max.year.origin)
    ][
      # order(stand.number, decreasing = TRUE)
      order(db_description_species$name)
        ] %>% 
  flextable() %>% 
  italic(i = NULL, j = 1, italic = TRUE, part = "body") %>%
  colformat_double(j = c(2), big.mark = "", digits = 0) %>%
  colformat_double(j = c(3:6), digits = 1) %>%
  colformat_double(j = c(7:10), big.mark = "", digits = 0) %>%
  set_header_labels(name = "Species", stand.number = "Number of stands", mean.age = "Mean", sd.age = "s.d.", min.age = "Min", max.age = "Max", mean.height = "Mean", sd.height = "s.d", min.year.origin = "Min", max.year.origin = "Max") %>%
  # set_caption(
  #   caption = "Calibration data", 
  #   autonum = T
  #   ) %>% 
  add_header_row(top = TRUE, values = c("", "", "SDH", "Age", "Origin year"), colwidths = c(1,1,2,4,2)) %>%
  add_footer_row(values = "Age in years, SDH in meters. Only stands with complete data and with origin-year after 1871 are considered. NFI data contain a single SDH measure for each stand. s.d. : standard deviation",colwidths = 10) %>%
  theme_booktabs() %>% # default theme
  font(fontname = "Calibri (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  height_all(height = 1, unit = "cm") %>%
  width(width = 1.5, unit = "cm") %>%
  width(width = 2, j = 2, unit = "cm") %>%
  width(width = 3, j = 1, unit = "cm") %>%
  align_text_col(align = "center", header = TRUE, footer = TRUE) %>%
  align_nottext_col(align = "center", header = TRUE, footer = TRUE) %>%
  vline(i = NULL, j = NULL, border = officer::fp_border(color="black"), part = "all")
  # fit_to_width(
  #   max_width = 17,
  #   inc = 1L,
  #   max_iter = 10,
  #   unit = "cm"
  #   )

save_as_docx(db_description_species_print, path = paste0(dir.fig.tab, "/stand_description.docx"))

```


# Graph initial climate and climate dynamics

```{r}
tar_load(list_boxplot_climate.initial, store = dir.target.store_absolute_analysis)
tar_load(graph_Tmean.dynamics_year, store = dir.target.store_absolute_analysis)
tar_load(graph_precipitation.dynamics_year, store = dir.target.store_absolute_analysis)
tar_load(graph_cwb.dynamics_year, store = dir.target.store_absolute_analysis)


graph_Tmean = graph_Tmean.dynamics_year
graph_precipitation = graph_precipitation.dynamics_year
graph_cwb = graph_cwb.dynamics_year

# size parameters
  text.size.main = 7

  # graph reference period
  
  graph_climate.reference <- plot_grid(
    plotlist = list(
      list_boxplot_climate.initial[["Tmean_9_8"]] +
        geom_boxplot(
          outlier.shape = NA,
          fill = "grey",
          linewidth = 0.1
        ) +
        theme_bw() + 
        xlim(c(0,NA)) +
        theme(
          axis.title = element_blank(),
          axis.text = element_text(size = text.size.main),
          plot.margin = unit(c(0.4,0,0,0), "cm")
        ) +
        geom_vline(xintercept = 0, lty = "dashed", linewidth = 0.2),
      list_boxplot_climate.initial[["precipitation_9_8"]] +
        geom_boxplot(
          outlier.shape = NA,
          fill = "grey",
          linewidth = 0.1
        ) +
        theme_bw() + 
        xlim(c(0,NA)) +
        theme(
          axis.title = element_blank(),
          axis.text = element_text(size = text.size.main),
          axis.text.y = element_blank(),
          plot.margin = unit(c(0.4,0,0,0), "cm")
        ) +
        geom_vline(xintercept = 0, lty = "dashed", linewidth = 0.2),
      list_boxplot_climate.initial[["cwb_9_8"]] +
        geom_boxplot(
          outlier.shape = NA,
          fill = "grey",
          linewidth = 0.1
        ) +
        theme_bw() + 
        # xlim(c(0,16)) +
        theme(
          axis.title = element_blank(),
          axis.text = element_text(size = text.size.main),
          axis.text.y = element_blank(),
          plot.margin = unit(c(0.4,0,0,0), "cm")
        ) +
        geom_vline(xintercept = 0, lty = "dashed", linewidth = 0.2)
    ),
    labels = c(
      "Annual mean temperature (°C)",
      "Annual precipitation (mm)",
      "Annual climatic water balance (mm)"
    ),
    ncol = 3,
    rel_widths = c(1.7,1,1),
    label_size = text.size.main,
    label_x = c(0.4, 0.1, 0.1),
    label_y = 1,
    hjust = 0,
    vjust = 1.5
  ) + theme(
    plot.margin = unit(c(0.4,0,0.2,0.1), "cm")
  )
  
  # graph climate dynamics ----
    
    # get legend
    graph_Tmean_temp <- graph_Tmean
    graph_Tmean_temp <- graph_Tmean_temp + theme(
      legend.direction ="horizontal",
      legend.text = element_text(size = text.size.main), 
      legend.key.height = unit(0.2, 'cm'), #change legend key height
      legend.key.width = unit(0.2, 'cm'), #change legend key width
      legend.title = element_text(size = text.size.main) #change legend title font size
      ) +
      scale_fill_manual(
        name = "Climate anomaly",
        values = c("red", "blue"),
        breaks = c("positive", "negative"), 
        labels = c("positive", "negative")
      )
    legend.dynamics.Tmean<- get_legend(graph_Tmean_temp)
    
    graph_precipitation_temp <- graph_precipitation
    graph_precipitation_temp <- graph_precipitation_temp + theme(
      legend.direction ="horizontal",
      legend.text = element_text(size = text.size.main), 
      legend.key.height = unit(0.2, 'cm'), #change legend key height
      legend.key.width = unit(0.2, 'cm'), #change legend key width
      legend.title = element_text(size = text.size.main) #change legend title font size
    )+
      scale_fill_manual(
        name = "Climate anomaly",
        values = c("green", "orange"),
        breaks = c("positive", "negative"), 
        labels = c("positive", "negative")
      )
    legend.dynamics.precipitation <- get_legend(graph_precipitation_temp)
    
    # plot
    graph_climate.dynamics <- plot_grid(
      plotlist = list(
          graph_Tmean +
            theme_bw() + 
            # geom_line(aes(y=data.table::frollmean(value.recent, 5, align = "center", na.rm = T)), col = "red") +
            theme(
              legend.position = "none",
              plot.title = element_blank(),
              plot.margin = unit(c(0.4,0,0,0), "cm"),
              axis.text = element_text(size = text.size.main),
              axis.title = element_text(size = text.size.main)
            ) +
            scale_fill_manual(
              name = "Climate anomaly",
              values = c("red", "blue"),
              breaks = c("positive", "negative"), 
              labels = c("positive", "negative")
            ) ,
          graph_precipitation +
            theme_bw() + 
            # geom_line(aes(y=data.table::frollmean(value.recent, 5, align = "center", na.rm = T)), col = "red") +
            theme(
              legend.position = "none",
              plot.title = element_blank(),
              plot.margin = unit(c(0.4,0,0,0), "cm"),
              axis.text = element_text(size = text.size.main),
              axis.title = element_text(size = text.size.main)
            ) +
            scale_fill_manual(
              name = "Climate anomaly",
              values = c("green", "orange"),
              breaks = c("positive", "negative"), 
              labels = c("positive", "negative")
            ),
          graph_cwb +
            theme_bw() + 
            # geom_line(aes(y=data.table::frollmean(value.recent, 5, align = "center", na.rm = T)), col = "red") +
            theme(
              legend.position = "none",
              plot.title = element_blank(),
              plot.margin = unit(c(0.4,0,0,0), "cm"),
              axis.text = element_text(size = text.size.main),
              axis.title = element_text(size = text.size.main)
            ) +
            scale_fill_manual(
              name = "Climate anomaly",
              values = c("green", "orange"),
              breaks = c("positive", "negative"), 
              labels = c("positive", "negative")
            )
          ), 
      labels = c(
        "Annual mean temperature anomaly (°C)",
        "Annual precipitation anomaly (mm)",
        "Annual climatic water balance anomaly (mm)"
        ),
      ncol = 3,
      label_size = text.size.main,
      label_x = 0.1,
      label_y = 1,
      hjust = 0,
      vjust = 1.5
    )
    
    # legend
    
    graph_climate.dynamics_legend <- plot_grid(
      plotlist = list(legend.dynamics.Tmean, legend.dynamics.precipitation), 
      ncol = 2, 
      rel_widths = c(1,2)
    )
  
  # all
  graph_all <- plot_grid(
    plotlist = list(
      graph_climate.reference + theme(
        plot.margin = unit(c(0.5,0.3,0,0), "cm")
      ),
      graph_climate.dynamics + theme(
        plot.margin = unit(c(0.5,0.3,0,0), "cm")
      ),
      graph_climate.dynamics_legend
    ),
    nrow = 3,
    labels = c(
      "Reference climate (average 1891- 1920)",
      "Climate anomaly compared to reference climate (average 1891-1920)", 
      NULL
      ),
    label_size = 1.3 * text.size.main,
    label_x = 0,
    label_y = 1,
    hjust = 0,
    vjust = 1.5,
    rel_heights = c(1,1,0.1)
  )
  
  
  ggsave(
    filename = paste0("graph.climate.initial.anomaly", ".jpg"),
    plot = graph_all,
    path = dir.fig.tab,
    height = 15,
    width = 17,
    units = "cm",
    limitsize = FALSE
  )
  
```



# Graph partial impact

```{r partial impact}

tar_load(list_direct.partial.impact, store = dir.target.store_absolute_analysis)
list_variable.impact <- list_direct.partial.impact
text.size.main <- 5
ymin <- 10
ymax <- 45

  db_variable_impact <- rbindlist(list_variable.impact)[species %in% species_list]
  db_variable_impact <- merge(db_variable_impact, db_species.name[, .(code, name, name.short)], by.x  = "species", by.y = "code")
  
  db_variable_impact$name <- as.factor(db_variable_impact$name)
  
  db_variable_impact[, season := paste0(str_split(variable, "_", simplify = T)[,2],"_",str_split(variable, "_", simplify = T)[,3])]
  db_variable_impact[, season.name := character()]
  db_variable_impact[ season == "9_11", season.name := "Fall"]
  db_variable_impact[ season == "12_2", season.name := "Winter"]
  db_variable_impact[ season == "9_2", season.name := "Fall + winter"]
  db_variable_impact[ season == "3_5", season.name := "Spring"]
  db_variable_impact[ season == "6_8", season.name := "Summer"]
  db_variable_impact[ season == "3_8", season.name := "Spring + summer"]
  db_variable_impact[ season == "1_12", season.name := "Whole year"]
  
  # build legend
  
  # vec.color <- rainbow(length(levels(db_variable_impact$name)))
  vec.color <-  c(
    "#FF0000",
    "#FF4D00",
    "#FF9900",
    "#8B8878",
    "#458B00",
    "#6E8B3D",
    "#8B6914",
    "#008B00",
    "#8B3A62",
    "#008B8B",
    "#FF8C69",
    "#00B3FF",
    "#0066FF",
    "#001AFF",
    "#3300FF",
    "#7F00FF",
    "#CC00FF",
    "#FF00E6",
    "#FF0099",
    "#FF004D"
  )
  
  vec.color <- vec.color[1 : length(levels(db_variable_impact$name))] # in case we deal with a subsample of species
  
  db_legend <- db_species.name[name %in% levels(db_variable_impact$name)]
  db_legend[, ":="(color = vec.color, label = paste0(name, " (", name.short, ")"))]
  
  barplot(1 : length(levels(db_variable_impact$name)), col = vec.color)
  
  # variables to create loop on
  list_season.name <- c("Fall","Winter","Fall + winter","Spring","Summer","Spring + summer","Whole year")
  variable.type <- c("Tmean", "precipitation", "cwb", "sgdd")
  
  list_graph_partial.impact <- lapply(variable.type, function(variable.type.selected){
    
    list_graph_partial.impact_variable.type.selected <- lapply(list_season.name, function(season.name.selected){
      
      db_variable_impact.selected <- db_variable_impact[
        str_detect(variable, variable.type.selected) & season.name == season.name.selected
      ]
      
      if(nrow(db_variable_impact.selected) == 0){return(NULL)} # case no significant variable
      
      db_label.selected <- unique(db_variable_impact.selected[, .(
        x = value_abs[3] + 0.2 * abs(value_abs[1]),
        y = SDH[3] + 2,
        name = name, 
        name.short = name.short
      ),
      by = c("species", "variable")]
      )
      
      db_legend.selected <- db_legend[name %in% db_variable_impact.selected$name]
      
      
      graph_partial.impact_variable.type.selected_season.selected <- ggplot(
      ) +
        geom_line(
          data = db_variable_impact.selected, 
          aes(
            x = value_abs,
            y = SDH, 
            color = name
          ),
          linewidth = 0.1
        ) +
        ggrepel::geom_text_repel(
          data = db_label.selected,
          aes(
            x = x,
            y = y, 
            color = name,
            label = name.short
          ),
          size = text.size.main / 2,
          min.segment.length = unit(1, "cm"), 
          arrow = arrow()
        ) +
        theme_bw() +
        ylim(ymin, ymax) +
        scale_linetype_manual(
          values = c("TRUE" = "solid", "FALSE" = "dashed")
        ) +
        scale_color_manual(
          values = db_legend.selected$color,
          breaks = db_legend.selected$name, 
          labels = db_legend.selected$label
        ) +
        guides(
          color = guide_legend(title = "Species", nrow = 5, byrow = TRUE),
          # color = "none",
          # linetype = guide_legend(title = NULL, keywidth = 2),
          linetype = "none",
          size = "none"
        ) +
        labs(
          x = variable.type.selected, 
          y = "Site index (m)"
        ) + 
        theme(legend.direction ="horizontal")
      
      return(graph_partial.impact_variable.type.selected_season.selected)
      
    })
    names(list_graph_partial.impact_variable.type.selected) <- list_season.name
    
    return(list_graph_partial.impact_variable.type.selected)
    
  })
  names(list_graph_partial.impact) <- variable.type
  
  # plot
  
  # margins.graph <- c(0,-0.1,0.1,-0.1)
  margins.graph <- c(0, 0, 0.1, 0)
  angle.graph <- 45
  
  # get legend ----
  
  graph.temp <- ggplot(
    data = db_variable_impact,
    aes(
      x = name,
      y = SDH, 
      color = name
    )
  ) +
    geom_boxplot(
    ) +
    scale_color_manual(
      values = db_legend$color,
      name = db_legend$name, 
      label = db_legend$label
    ) +
    guides(
      color = guide_legend(title = "Species", ncol = 3, byrow = TRUE),
      linetype = "none",
      size = "none"
    )+
    theme(
      legend.key.height = unit(0.2, 'cm'), #change legend key height
      legend.key.width = unit(0.2, 'cm'), #change legend key width
      legend.title = element_text(size = text.size.main), #change legend title font size
      legend.text = element_text(size = text.size.main)
    )
  
  legend <- get_legend(graph.temp)
  
  # get variables and seasons ----
  
  ratio.season.graph <- 1/20
  
  text.season <- plot_grid(
    plotlist = lapply(list_season.name, function(season.name.selected){
      ggpubr::text_grob(season.name.selected, rot = 90, size = 1.2 * text.size.main)
    }),
    ncol = 1,
    nrow = length(list_season.name)
  )
  
  text.variable <- plot_grid(
    plotlist = lapply(c("Mean temperature", "Precipitation", "Climatic water balance"), function(season.name.selected){
      ggpubr::text_grob(season.name.selected, size = 1.2 * text.size.main, just = "top")
    }),
    ncol = 3,
    nrow = 1
  )
  
  text.variable <- plot_grid(
    plotlist = list(
      NULL,
      text.variable
    ),
    ncol = 2,
    nrow = 1,
    rel_widths = c(ratio.season.graph, 1)
  )
  
  
  # graph temperature and sgdd ----
  
  # attention we plot together tempeture for non whole year period and gdd for the whole year period, since no whole yera temperature is never significant
  
  graph_sgdd <- plot_grid(
    plotlist = lapply("Whole year", function(season.selected){
      
      x <- list_graph_partial.impact$sgdd[[season.selected]]
      
      if(is.null(x)){
        
        x <- text_grob("No effect", size = 1.2 * text.size.main)
        
        return(x)
        
      }
      
      x <- x + 
        labs(y = "Site index (m)") +
        theme(
          legend.position = "none",
          plot.title = element_blank(), 
          axis.title.x = element_blank(),
          axis.title.y = element_text(hjust = 0.5, vjust = 0, angle = 90, size = text.size.main),
          axis.text = element_text(size = text.size.main),
          axis.text.x = element_text(angle = angle.graph, hjust = 1)
        )
      
      return(x)
      
    }),
    nrow = 1,
    ncol = 1
  ) +
    draw_label("SGDD (°C)", x = 0.5, y = 0, hjust = 0.5, vjust = 0, angle = 0, size = text.size.main)
  
  graph_temperature <- plot_grid(
    plotlist = lapply(setdiff(list_season.name, "Whole year"), function(season.selected){
      
      x <- list_graph_partial.impact$Tmean[[season.selected]]
      
      if(is.null(x)){
        
        x <- ggpubr::text_grob("No effect", size = 1.2 * text.size.main)
        
        return(x)
        
      }
      
      
      x <- x +
        labs(y = "Site index (m)") +
        theme(
          legend.position = "none",
          plot.title = element_blank(), 
          axis.title.x = element_blank(),
          axis.title.y = element_text(hjust = 0.5, vjust = 0, angle = 90, size = text.size.main),
          axis.text = element_text(size = text.size.main),
          axis.text.x = element_text(angle = angle.graph, hjust = 1)
        )
      
      return(x)
      
    }),
    ncol = 1,
    nrow = 6
  ) +
    draw_label("Temperature (°C)", x = 0.5, y = 0, hjust = 0.5, vjust = 0, angle = 0, size = text.size.main)
  
  graph_temperature_sgdd <- plot_grid(
    plotlist = list(
      graph_temperature,
      graph_sgdd
    ),
    ncol = 1,
    nrow = 2,
    rel_heights = c(6, 1)
  ) +
    theme(plot.margin = unit(margins.graph, "cm"))
  
  
  # precipitations ----
  
  graph_precipitations <- plot_grid(
    plotlist = lapply(setdiff(list_season.name, "Whole year"), function(season.selected){
      
      x <- list_graph_partial.impact$precipitation[[season.selected]]
      
      if(is.null(x)){
        
        x <- ggpubr::text_grob("No effect", size = 1.2 * text.size.main)
        
        return(x)
        
      }
      
      x <- x + theme(
        legend.position = "none",
        plot.title = element_blank(), 
        axis.title = element_blank(),
        axis.text = element_text(size = text.size.main),
        axis.text.x = element_text(angle = angle.graph, hjust = 1)
      )
      
      return(x)
      
    }),
    ncol = 1,
    nrow = 6
  ) +
    draw_label("Precipitations (mm)", x = 0.5, y = 0, hjust = 0.5, vjust = 0, angle = 0, size = text.size.main) +
    # draw_label("Site index (m)", x = 0, y = 0.5, hjust = 0, vjust = 0.5, angle = 90, size = text.size.main)+
    theme(plot.margin = unit(margins.graph, "cm"))
  
  
  # cwb ----
  
  graph_cwb <- plot_grid(
    plotlist = lapply(setdiff(list_season.name, "Whole year"), function(season.selected){
      
      x <- list_graph_partial.impact$cwb[[season.selected]]
      
      if(is.null(x)){
        
        x <- ggpubr::text_grob("No effect", size = 1.2 * text.size.main)
        
        return(x)
        
      }
      
      x <- x + theme(
        legend.position = "none",
        plot.title = element_blank(), 
        axis.title = element_blank(),
        axis.text = element_text(size = text.size.main),
        axis.text.x = element_text(angle = angle.graph, hjust = 1)
      )
      
      return(x)
      
    }),
    ncol = 1,
    nrow = 6
  ) +
    draw_label("Climatic water balance (mm)", x = 0.5, y = 0, hjust = 0.5, vjust = 0, angle = 0, size = text.size.main) +
    # draw_label("Site index (m)", x = 0, y = 0.5, hjust = 0, vjust = 0.5, angle = 90, size = text.size.main)+
    theme(plot.margin = unit(margins.graph, "cm"))
  
  # arrange ----
  
  graph_precipitations_cwb <- plot_grid(
    plotlist = list(
      graph_precipitations,
      graph_cwb
    ),
    ncol = 2,
    nrow = 1
  )
  
  graph_precipitations_cwb_legend <- plot_grid(
    plotlist = list(
      graph_precipitations_cwb,
      legend
    ),
    ncol = 1,
    nrow = 2, 
    rel_heights = c(6, 1)
  )
  
  graph_precipitations_cwb_legend_temperature <- plot_grid(
    plotlist = list(
      graph_temperature_sgdd,
      graph_precipitations_cwb_legend
    ),
    ncol = 2,
    nrow = 1,
    rel_widths = c(1, 2)
  )
  
  graph_all <- plot_grid(
    plotlist = list(
      text.season,
      graph_precipitations_cwb_legend_temperature
    ),
    ncol = 2,
    nrow = 1,
    rel_widths = c(ratio.season.graph, 1)
  )
  
  graph_partial.impact <- plot_grid(
    plotlist = list(
      text.variable,
      graph_all
    ),
    ncol = 1,
    nrow = 2,
    rel_heights = c(1/30, 1)
  ) +
    theme(plot.margin = unit(c(0,0,0.1,0), "cm"))
  

ggsave(
  filename = "graph_partial.impact.jpg",
  plot = graph_partial.impact,
  path = dir.fig.tab,
  height = 22, 
  width = 16, 
  units = "cm",
  limitsize = FALSE
)

```

# Graph dynamics Abies alba

```{r}
tar_load(list_graph_dynamics_virtual_1891_1920_vs_actual, store = dir.target.store_absolute_analysis)

name.graph <- sapply(list_graph_dynamics_virtual_1891_1920_vs_actual, function(x){return(x$species)})
list_graph.dyna <- lapply(list_graph_dynamics_virtual_1891_1920_vs_actual, function(x){return(x$graph)})
names(list_graph.dyna) <- name.graph


graph_dyna.61 <- list_graph.dyna$`61` + 
  theme_bw() +
  ylab("Stand dominant height (m)") +
  ggtitle("Abies alba stand dominant height dynamics")

ggsave(
  filename = "graph_dyna.61.jpg",
  plot = graph_dyna.61,
  path = dir.fig.tab,
  height = 10, 
  width = 17, 
  units = "cm",
  limitsize = FALSE
)

```



# Graph interspecific

```{r CC impact on SDH - interspecific}

tar_load(graph_CCimpact_interspecific_virtual_1891_1920_vs_actual, store = dir.target.store_absolute_analysis)


graph.interspecific <-  graph_CCimpact_interspecific_virtual_1891_1920_vs_actual +
  geom_boxplot(
    outlier.shape = NA,
    fill = "grey"
  ) +
  theme_bw() + 
  theme(
    axis.text.x = element_text(angle = 45, vjust = 0.7),
    panel.grid.major.x = element_blank() ,
    panel.grid.major.y = element_line( linewidth=.1, color="black" ) 
  ) +
  labs(
    y = "Impact of climate change on site index (%)"
  )


ggsave(
  filename = "graph.interspecific.jpg",
  plot = graph.interspecific,
  path = dir.fig.tab,
  height = 12, 
  width = 17, 
  units = "cm",
  limitsize = FALSE
)

```
# Graph intraspecific

```{r CC impact on SDH - intraspecific}

tar_load(graph_CCimpact_intraspecific_Tmean.initial_virtual_1891_1920_vs_actual, store = dir.target.store_absolute_analysis)

text.size.main <- 5


graph.intraspecific_all <- plot_grid(
  plotlist = lapply(graph_CCimpact_intraspecific_Tmean.initial_virtual_1891_1920_vs_actual, function(x){
    x <- x +
      theme(
        legend.position="none",
        plot.margin = unit(c(0,0.1,0.1,0.1), "cm"),
        plot.title = element_text(vjust = 0, size = 1.2 * text.size.main)
      )
    }),
  ncol = 3,
  nrow = 6
) +
draw_label("Annual mean temperature (°C) over the reference period (1891-1920)", x = 0.5, y = 0, hjust = 0.5, vjust = 1, angle = 0, size = 1.2 * text.size.main) +
draw_label("Impact of climate change on site index (%)", x = 0, y = 0.5, hjust = 0.5, vjust = 0, angle = 90, size = 1.2 * text.size.main) +
theme(plot.margin = unit(c(0.1,0,0.4,0.4), "cm"))


graph.intraspecific_1 <- plot_grid(
  plotlist = lapply(graph_CCimpact_intraspecific_Tmean.initial_virtual_1891_1920_vs_actual[1:12], function(x){
    x <- x +
      theme(
        legend.position="none",
        plot.margin = unit(c(0,0.1,0.1,0.1), "cm"),
        plot.title = element_text(vjust = 0, size = 1.2 * text.size.main)
      )
    }),
  ncol = 3,
  nrow = 4
) +
draw_label("Annual mean temperature (°C) over the reference period (1891-1920)", x = 0.5, y = 0, hjust = 0.5, vjust = 1, angle = 0, size = 1.2 * text.size.main) +
draw_label("Impact of climate change on site index (%)", x = 0, y = 0.5, hjust = 0.5, vjust = 0, angle = 90, size = 1.2 * text.size.main) +
theme(plot.margin = unit(c(0.1,0,0.4,0.4), "cm"))

graph.intraspecific_2 <- plot_grid(
  plotlist = lapply(graph_CCimpact_intraspecific_Tmean.initial_virtual_1891_1920_vs_actual[13:18], function(x){
    x <- x +
      theme(
        legend.position="none",
        plot.margin = unit(c(0,0.1,0.1,0.1), "cm"),
        plot.title = element_text(vjust = 0, size = 1.2 * text.size.main)
      )
    }),
  ncol = 3,
  nrow = 2
) +
draw_label("Annual mean temperature (°C) over the reference period (1891-1920)", x = 0.5, y = 0, hjust = 0.5, vjust = 1, angle = 0, size = 1.2 * text.size.main) +
draw_label("Impact of climate change on site index (%)", x = 0, y = 0.5, hjust = 0.5, vjust = 0, angle = 90, size = 1.2 * text.size.main) +
theme(plot.margin = unit(c(0.1,0,0.4,0.4), "cm"))


ggsave(
  filename = "graph.intraspecific_all.jpg",
  plot = graph.intraspecific_all,
  path = dir.fig.tab,
  height = 20, 
  width = 17, 
  units = "cm",
  limitsize = FALSE
)

ggsave(
  filename = "graph.intraspecific_1.jpg",
  plot = graph.intraspecific_1,
  path = dir.fig.tab,
  height = 20, 
  width = 17, 
  units = "cm",
  limitsize = FALSE
)

ggsave(
  filename = "graph.intraspecific_2.jpg",
  plot = graph.intraspecific_2,
  path = dir.fig.tab,
  height = 10, 
  width = 17, 
  units = "cm",
  limitsize = FALSE
)


```


# Supplementary materials

## Climate trends

```{r}
tar_load(list_boxplot_climate.evolution, store = paste0(dir,"/store_analysis_part1_new"))

  text.size.main = 5
  
  # annual graph
  plotlist = list_boxplot_climate.evolution
  variable.to.plot <- c("Tmean_9_8", "precipitation_9_8", "cwb_9_8")
  plotlist <- plotlist[names(plotlist) %in% variable.to.plot]
  
  # remove title
  plotlist.prepared <- lapply(names(plotlist), function(name.graph.selected){
    
    graph.selected <- plotlist[[name.graph.selected]] +
      geom_boxplot(
        lwd = 0.05,
        outlier.shape = NA,
        fill = "grey"
      ) +
      theme_bw() +
      geom_vline(xintercept = 0, lty = "dashed", linewidth = 0.2) +
      theme(
        plot.title = element_blank(),
        legend.position = "none",
        axis.title = element_text(size = text.size.main),
        axis.text = element_text(size = text.size.main)
      )
    return(graph.selected)
    
  })
  names(plotlist.prepared) <- names(plotlist)
  
  
  graph_climate.evolution_year <- plot_grid(
    plotlist = list(
      plotlist.prepared[[1]] +
        theme(
          axis.title.y = element_blank()
        ) +
        xlab("Annual mean temperatures (°C)"),
      plotlist.prepared[[2]] +
        theme(
          axis.title.y = element_blank(),
          axis.text.y = element_blank()
        ) +
        xlab("Annual precipitation (mm)"),
      plotlist.prepared[[3]] +
        theme(
          axis.title.y = element_blank(),
          axis.text.y = element_blank()
          ) +
        xlab("Annual climatic water balance (mm)")
    ),
    ncol = 3,
    nrow = 1,
    rel_widths = c(1.4, 1, 1)
  ) + theme(
    plot.margin = unit(c(0.4,0,0.2,0.1), "cm")
  )

  ggsave(
  filename = "graph_climate.evolution_year.jpg",
  plot = graph_climate.evolution_year ,
  path = dir.fig.tab,
  height = 12, 
  width = 17, 
  units = "cm",
  limitsize = FALSE
)
  
   
  # summer graph
  
  plotlist = list_boxplot_climate.evolution
  variable.to.plot <- c("Tmean_6_8", "precipitation_6_8", "cwb_6_8")
  plotlist <- plotlist[names(plotlist) %in% variable.to.plot]
  
  # remove title
  plotlist.prepared <- lapply(names(plotlist), function(name.graph.selected){
    
    graph.selected <- plotlist[[name.graph.selected]] +
      geom_boxplot(
        lwd = 0.05,
        outlier.shape = NA,
        fill = "grey"
      ) +
      theme_bw() +
      geom_vline(xintercept = 0, lty = "dashed", linewidth = 0.2) +
      theme(
        plot.title = element_blank(),
        legend.position = "none",
        axis.title = element_text(size = text.size.main),
        axis.text = element_text(size = text.size.main)
      )
    return(graph.selected)
    
  })
  names(plotlist.prepared) <- names(plotlist)
  
  
  graph_climate.evolution_summer <- plot_grid(
    plotlist = list(
      plotlist.prepared[[1]] +
        theme(
          axis.title.y = element_blank()
        ) +
        xlab("Annual mean temperatures (°C)"),
      plotlist.prepared[[2]] +
        theme(
          axis.title.y = element_blank(),
          axis.text.y = element_blank()
        ) +
        xlab("Annual precipitation (mm)"),
      plotlist.prepared[[3]] +
        theme(
          axis.title.y = element_blank(),
          axis.text.y = element_blank()
          ) +
        xlab("Annual climatic water balance (mm)")
    ),
    ncol = 3,
    nrow = 1,
    rel_widths = c(1.4, 1, 1)
  ) + theme(
    plot.margin = unit(c(0.4,0,0.2,0.1), "cm")
  )

  ggsave(
    filename = "graph_climate.evolution_summer.jpg",
    plot = graph_climate.evolution_summer ,
    path = dir.fig.tab,
    height = 12, 
    width = 17, 
    units = "cm",
    limitsize = FALSE
  )

```

## Description of non-climatic variables

```{r}
tar_load(db_description_nonclimatic.data, store = paste0(dir,"/store_analysis_part1_new"))

```

```{r variablesnonclimaticquanti, results='asis'}
db_quanti <- db_description_nonclimatic.data$quanti
db_quanti <- db_quanti[,
    .(name, min, median, max, sd, unit)
    ] %>% 
  flextable() %>% 
  align(part = "all") %>% # left align
  font(fontname = "Calibri (Body)", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  # add_footer_row(values = "Age in years, SDH in meters. Only stands with complete explanatory data and with origin-years equal or more recent than 1872 are considered.",
  #                colwidths = 8) %>%
  theme_booktabs() %>% # default theme
  autofit()

save_as_docx(db_quanti, path = paste0(dir.fig.tab, "/db_quanti.docx"))
```

```{r rochetype, results='asis'}

db_ROCHE.Calc <- as.data.table(db_description_nonclimatic.data$quali$ROCHE.Calc)

db_ROCHE.Calc[ROCHE.Calc == 0, type:= "non calcareous"]
db_ROCHE.Calc[ROCHE.Calc == 1, type:= "calcareous"]

db_ROCHE.Calc <- db_ROCHE.Calc[
  ,.(
    type,
    N
    )
] %>% 
  flextable() %>% 
  align(part = "all") %>% # left align
  add_footer_row(values = "N: Number of stands in each category", colwidths = 2) %>%
  font(fontname = "Calibri (Body)", part = "all") %>%
  theme_booktabs() %>% # default theme
  autofit()

save_as_docx(db_ROCHE.Calc, path = paste0(dir.fig.tab, "/db_ROCHE.Calc.docx"))

```

```{r humustype, results='asis'}

db_humus_type <- as.data.table(db_description_nonclimatic.data$quali$humus_type)

db_humus_type <- db_humus_type[
  ,.(
    `humus type` = humus_type,
    N
    )
] %>% 
  flextable() %>% 
  align(part = "all") %>% # left align
  font(fontname = "Calibri (Body)", part = "all") %>% 
  add_footer_row(values = "N: Number of stands in each category", colwidths = 2) %>%
  font(fontname = "Calibri (Body)", part = "all") %>%
  theme_booktabs() %>% # default theme
  autofit()

save_as_docx(db_humus_type, path = paste0(dir.fig.tab, "/db_humus_type.docx"))
```

```{r soiltype, results='asis'}

db_soil_type <- as.data.table(db_description_nonclimatic.data$quali$soil_type)

db_soil_type <- db_soil_type[
  ,.(
    `soil type` = soil_type,
    N
    )
] %>% 
  flextable() %>% 
  align(part = "all") %>% # left align
  font(fontname = "Calibri (Body)", part = "all") %>% 
  add_footer_row(values = "N: Number of stands in each category", colwidths = 2) %>%
  font(fontname = "Calibri (Body)", part = "all") %>%
  theme_booktabs() %>% # default theme
  autofit()

save_as_docx(db_soil_type, path = paste0(dir.fig.tab, "/db_soil_type.docx"))

```

## table quality metrics

```{r rmse and bias}

tar_load(output_summary, store = dir.target.store_absolute_analysis)
tar_load(graph.optimism, store = dir.target.store_absolute_analysis)

db.quality.indicators <- merge(output_summary$db_summary, graph.optimism[, .(species.code, optimism)], by.x = "code", by.y = "species.code")

db.quality.indicators.print <- db.quality.indicators[
  order(name)
  ][
  ,.(
    species = name,
    `RMSE (m)` = round(rmse,1),
    `RMSPE (%)` = round(rmspe,1),
    `bias (m)` = round(bias,1), 
    `optimism (%)` = round(optimism * 100,1)
    )
  ] %>% 
  flextable() %>% 
  italic(i = NULL, j = 1, italic = TRUE, part = "body") %>%
  align_text_col(align = "center", header = TRUE, footer = TRUE) %>%
  font(fontname = "Calibri (Body)", part = "all") %>%
  fontsize(size = 10, part = "body") %>% 
  add_footer_row(values = "Metrics computed over all stand used for the calibration",colwidths = 5) %>%
  theme_booktabs() %>% # default theme
  height_all(height = 1, unit = "cm") %>%
  width(width = 1.5, unit = "cm") %>%
  width(width = 2.5, j = 1, unit = "cm") %>%
  align_text_col(align = "center", header = TRUE, footer = TRUE) %>%
  align_nottext_col(align = "center", header = TRUE, footer = TRUE) %>%
  autofit()

  save_as_docx(db.quality.indicators.print, path = paste0(dir.fig.tab, "/db.quality.indicators.docx"))

```

## Graph optimism

```{r}
tar_load(c("list_analysis.rmse.bias", "db_species.name", "db_stand.number"), store = dir.target.store_absolute_analysis)

list_metrics = list_analysis.rmse.bias
db_species.name = db_species.name


  list_species <- sapply(list_metrics, function(analysis.rmse.selected){
    return(analysis.rmse.selected$species_code)
  })
  names(list_metrics) <- list_species
  
  
  db_optimism <- rbindlist(lapply(list_species, function(species.selected){
    
    analysis.rmse.selected <- list_metrics[[species.selected]]
    
    optimism <- analysis.rmse.selected$list_metrics.submodel[, mean(pmax(rmse.validation - rmse.calibration, 0)/rmse.calibration)]
    
    return(
      data.table(
        species.code = species.selected,
        optimism = optimism
      )
    )
    
  }))
  
  db_optimism <- db_optimism %>%
    merge(db_stand.number, by = "species.code") %>%
    merge(db_species.name, by.x = "species.code", by.y = "code")
  
  # plot
  graph_optimism_stand.nb <- ggplot(
    data = db_optimism, 
    aes(
      x = N, 
      y = optimism * 100,
      label = name
    )
  ) +
    geom_point(
      size = 0.5
    ) +
    theme_bw() +
    ggrepel::geom_text_repel(
      color = "black",
      alpha = 0.7,
      size=2,
      box.padding = unit(0.5, "lines")
    ) +
    labs(
      x = "Number of stands",
      y = "Optimism"
    )+
    theme(
      axis.title = element_text(size = 6),
      axis.text = element_text(size = 6)
    ) +
    scale_y_continuous(
      breaks = round(seq(0, 100 * db_optimism[, max(optimism)] + 10, 10)),
      minor_breaks = NULL,
      labels = paste0(round(seq(0, 100 * db_optimism[, max(optimism)] + 10, 10)), "%")
    )
  
  
  ggsave(
    filename = "graph_optimism_stand.nb.jpg",
    plot = graph_optimism_stand.nb ,
    path = dir.fig.tab,
    height = 15, 
    width = 17, 
    units = "cm",
    limitsize = FALSE
  )


```

## SDH dynamics - all species

```{r}

tar_load(list_graph_dynamics_virtual_1891_1920_vs_actual, store = dir.target.store_absolute_analysis)


plotlist = list_graph_dynamics_virtual_1891_1920_vs_actual
y.max <- 45
text.size.main <- 6


# get legend
  
  graph.temp <- plotlist[[1]]$graph + theme(
    legend.title = element_text(size = text.size.main), #change legend title font size
    legend.text = element_text(size = text.size.main), #change legend text font size
    legend.direction = "vertical",
    legend.key.height = unit(0.5, "cm"),
    legend.key.width = unit(0.7, "cm")
  )  +
    theme(
      legend.direction = "horizontal",
      legend.spacing.y = unit(0.05, "cm")
    )
    
    
  legend <- get_legend(graph.temp)
  
  # remove title
  plotlist.prepared <- lapply(1 : length(species_list), function(index){
    
    graph.selected <- plotlist[[index]]$graph
    
    graph.selected <- graph.selected +
      theme_bw() + 
      theme(
        plot.title = element_blank(),
        legend.position="none",
        axis.title = element_blank(),
        axis.text = element_text(size = text.size.main),
        plot.margin = unit(c(0.3, 0, 0, 0.2), "cm")
      ) +
      ylim(c(0, y.max))
    
    return(graph.selected)
    
  })
  names(plotlist.prepared) <- species_list
  
  
  # order
  plotlist.prepared <- plotlist.prepared[db_species.name[order(name), code]]
  
  # plot grid

  graph_dynamics_virtual_1891_1920_vs_actual <- plot_grid(
    plotlist = plotlist.prepared,
    labels = db_species.name[match(names(plotlist.prepared), code), name],
    ncol = 4,
    nrow = 5,
    scale = 1,
    label_size = text.size.main,
    label_x = 0.05,
    label_y = 1,
    hjust = 0,
    vjust = 1.5
  ) +
    theme(plot.margin = unit(c(0, 0, 0.1, 0), "cm")) +
    draw_label("date", x = 0.5, y = 0, hjust = 0.5, vjust = 1, angle = 0, size = 1.2 * text.size.main) +
    draw_label("SDH (m)", x = 0, y = 0.5, hjust = 1, vjust = 0.5, angle = 90, size = 1.2 * text.size.main) +
    theme(plot.margin = unit(c(0, 0.3, 0, 0.3), "cm"))
  
  graph_dynamics_virtual_1891_1920_vs_actual <- plot_grid(
    plotlist = list(graph_dynamics_virtual_1891_1920_vs_actual, legend),
    nrow = 2,
    rel_heights = c(1, 0.1)
  )
  
  ggsave(
    filename = "graph_dynamics_virtual_1891_1920_vs_actual.jpg",
    plot = graph_dynamics_virtual_1891_1920_vs_actual ,
    path = dir.fig.tab,
    height = 24, 
    width = 17, 
    units = "cm",
    limitsize = FALSE
  )  



```
## Relationship CC impact / climatic niche (interspecific)

```{r}
tar_load(list_db_impact_virtual_1891_1920_vs_actual.named, store = dir.target.store_absolute_analysis)
tar_load(list_climate.virtual_1891_1920.named, store = dir.target.store_absolute_analysis)
tar_load(db_species.name, store = dir.target.store_absolute_analysis)

variable.focus <- c("Tmean_9_8", "precipitation_9_8")

# get climate
db_climate.ref <- rbindlist(lapply(species_list, function(species.selected){
  
  print(species.selected)
  
  # initial climate
  db_climate.ref_species.selected <- list_climate.virtual_1891_1920.named[[species.selected]][[1]]$year[, lapply(.SD, function(x){mean(x)}), by = "stand", .SDcols = variable.focus]
  db_climate.ref_species.selected <- melt(db_climate.ref_species.selected, id.vars = "stand", variable.name = "variable", value.name = "value")
  
  # add species
  db_climate.ref_species.selected[, species_code := species.selected]
  
  return(db_climate.ref_species.selected)
  
}))
db_climate.ref_mean <- db_climate.ref[, .(value.mean = mean(value)), by = c("species_code", "variable")]
  
  
# get impact
db_impact <- rbindlist(list_db_impact_virtual_1891_1920_vs_actual.named)
db_impact_mean <- db_impact[, .(height.gap.rel.mean = mean(height.gap.rel)), by = "species_code"]

# merge
db_climate_impact <- merge(db_impact_mean, db_climate.ref_mean, by = "species_code")
db_climate_impact <- merge(db_climate_impact, db_species.name, by.x = "species_code", by.y = "code")

# plot for temperature
#################################

variable.selected <- "Tmean_9_8"
label.x.axis <- "Mean annual temperature (°C)"

  y.min <- 100 * min(db_climate_impact[variable == variable.selected, height.gap.rel.mean]) - 1
  y.max <- 100 * max(db_climate_impact[variable == variable.selected, height.gap.rel.mean]) + 1
  
  graph_CC.impact_climatic.niche_interspe_Tmean <- ggplot(
    data = db_climate_impact[variable == variable.selected], 
    aes(
      x = value.mean,
      y = 100 * height.gap.rel.mean,
      label = name.short
    )
  ) +
    geom_point(
      size = 0.2
    ) +
    theme_bw() +
    geom_text_repel(
      color = "black",
      alpha = 0.7,
      size = 2,
      box.padding = unit(0.3, "lines")
    ) +
    labs(
      x = label.x.axis, 
      y = paste0("Climate change impact on site index (%)")
    )+   
    theme(
      axis.title = element_text(size = 5), 
      axis.text = element_text(size = 5)
    ) +
    coord_cartesian(
      ylim = c(y.min, y.max)
      ) +
    scale_y_continuous(
      breaks = round(seq(y.min, y.max, 5)),
      minor_breaks = NULL,
      labels = paste0(round(seq(y.min, y.max, 5)), "%")
    )

ggsave(
  filename = "graph_CC.impact_climatic.niche_interspe_Tmean.jpg",
  plot = graph_CC.impact_climatic.niche_interspe_Tmean,
  path = dir.fig.tab,
  height = 10, 
  width = 10, 
  units = "cm",
  limitsize = FALSE
)

# plot for precipitation
#################################

variable.selected <- "precipitation_9_8"
label.x.axis <- "Total annual precipitation (mm)"

  y.min <- 100 * min(db_climate_impact[variable == variable.selected, height.gap.rel.mean]) - 1
  y.max <- 100 * max(db_climate_impact[variable == variable.selected, height.gap.rel.mean]) + 1
  
  graph_CC.impact_climatic.niche_interspe_prec <- ggplot(
    data = db_climate_impact[variable == variable.selected], 
    aes(
      x = value.mean,
      y = 100 * height.gap.rel.mean,
      label = name.short
    )
  ) +
    geom_point(
      size = 0.2
    ) +
    theme_bw() +
    geom_text_repel(
      color = "black",
      alpha = 0.7,
      size = 2,
      box.padding = unit(0.3, "lines")
    ) +
    labs(
      x = label.x.axis, 
      y = paste0("Climate change impact on site index (%)")
    )+   
    theme(
      axis.title = element_text(size = 5), 
      axis.text = element_text(size = 5)
    ) +
    coord_cartesian(
      ylim = c(y.min, y.max)
      ) +
    scale_y_continuous(
      breaks = round(seq(y.min, y.max, 5)),
      minor_breaks = NULL,
      labels = paste0(round(seq(y.min, y.max, 5)), "%")
    )

ggsave(
  filename = "graph_CC.impact_climatic.niche_interspe_prec.jpg",
  plot = graph_CC.impact_climatic.niche_interspe_prec,
  path = dir.fig.tab,
  height = 10, 
  width = 10, 
  units = "cm",
  limitsize = FALSE
)
```

## Parameter table

```{r}

# import parameter values
tar_load(parameter_list_named, store = dir.target.store_absolute_analysis)

# import normalization constant
db_normalization <- rbindlist(lapply(species_list, function(species.selected){
    
    list_data.explanatory <- readRDS(paste0(dir.data.calibration_absolute,"/db_for_inference_sp",species.selected,".rds"))

    db_normalization_constant <- list_data.explanatory$db_normalization_constant
    
    db_normalization_constant[, species.code:= species.selected]
    
    return(db_normalization_constant)
}))

# prepare db

db_parameter <- rbindlist(parameter_list_named)

db_parameter <- db_parameter %>%
  merge(db_species.name, by.x = "species_code", by.y = "code") %>%
  merge(db_normalization, by.x = c("species_code", "param"), by.y = c("species.code", "variable"), all.x = T)

db_parameter <- db_parameter[,.(
      name = name,
      param_class,
      param,
      estimate = round(estimate, 2),
      s.e. = round(sde, 2),
      pvalue = ifelse(pvalue >= 10^-2, round(pvalue,2), "< 0.01"), 
      normalization.mean = round(mean, 2),
      normalization.sd = round(sd, 2)
    )
  ]

# rename param_class
db_parameter[param == "A0", param_class:= "alpha"]
db_parameter[param == "C0", param_class:= "gamma"]
db_parameter[param_class == "beta" & param == "intercept", param:= "beta_0"]

db_parameter[param_class == "alpha", param_class:= "exp."]
db_parameter[param_class == "gamma", param_class:= "decl."]
db_parameter[param_class == "beta", param_class:= "shape"]
db_parameter[param_class == "sigma" | param_class == "delta", param_class:= "error"]

db_parameter$param_class <- factor(db_parameter$param_class, levels = c("exp.", "decl.", "shape", "error"))

# order

key <- c("name", "param_class", "param")

setkeyv(db_parameter, key)

db_parameter[str_detect(param, "square"), param:= paste0(str_remove(param, "_square"), "\n square")]


# print

db_parameter_print <- db_parameter %>% 
  flextable() %>% 
  italic(i = NULL, j = 1, italic = TRUE, part = "body") %>%
  # colformat_double(j = c(3:6), digits = 1) %>%
  set_header_labels(name = "Species", param_class = "Term", param = "Variable", estimate = "Estimate", pvalue = "p-value", normalization.mean = "Mean", normalization.sd = "s.d.") %>%
  add_header_row(top = TRUE, values = c("", "Parameter", "Values", "Normalization constants"), colwidths = c(1,2,3,2)) %>%
  # add_footer_row(values = "Age in years, SDH in meters. Only stands with complete data and with origin-year after 1871 are considered.",colwidths = 6) %>%
  theme_booktabs() %>% # default theme
  font(fontname = "Calibri (Body)", part = "all") %>% 
  fontsize(size = 6, part = "all") %>% 
  align_text_col(align = "center", header = TRUE, footer = TRUE) %>%
  align_nottext_col(align = "center", header = TRUE, footer = TRUE) %>%
  line_spacing(i = NULL, j = NULL, space = 0.8, part = "body") %>%
  height_all(0.5, part = "all", unit = "cm") %>%
  # width(width = 1, unit = "cm") %>%
  # width(width = 2, j = 1, unit = "cm") %>%
  fit_to_width(
  max_width = 17,
  inc = 1L,
  max_iter = 10,
  unit = "cm"
  ) 

  save_as_docx(db_parameter_print, path = paste0(dir.fig.tab, "/db_parameter.docx"))

```


# Graphical abstract

```{r graphical abstract}

tar_load(list_db_impact_virtual_1891_1920_vs_actual.named, store = dir.target.store_absolute_analysis)
tar_load(comparison.age, store= dir.target.store_absolute_analysis)
tar_load(db_species.name, store= dir.target.store_absolute_analysis)


list_db_impact = list_db_impact_virtual_1891_1920_vs_actual.named

y.min <- -0.13
y.max <- 0.23
text.size.main <- 5

      
  # get a single db with species
  db_impact <- rbindlist(list_db_impact)
  
  # species as factor
  db_impact[, species_code := as.factor(species_code)]
  
  # add species names
  db_impact <- merge(
    db_impact, 
    db_species.name, 
    by.x = "species_code",
    by.y = "code"
    )
  
  # summary (median, Q1, Q3, etc)
  
  db_impact_summary <- db_impact[
      , .(
        stand.number = length(unique(stand)),
        median = median(height.gap.rel),
        Q1 = quantile(height.gap.rel, 0.25),
        Q3 = quantile(height.gap.rel, 0.75)
        ), by = name
      ]
  db_impact_summary[, ":="(
    whisker_low_min = Q1 - 1.5 *(Q3 - Q1),
    whisker_high_max = Q3 + 1.5 *(Q3 - Q1)
  )]
  db_impact_summary <- db_impact_summary[order(median, decreasing = F)]
  
  factor.ordered <- db_impact_summary$name # 'all.CC_year' is the observed climate
  db_impact$name <- factor(db_impact$name, levels = factor.ordered)
  
  # proper whisker identification

  for(name.selected in factor.ordered){
    
    whisker_high_max <- db_impact_summary[name == name.selected, whisker_high_max]
    whisker_high.computed <- db_impact[name == name.selected & height.gap.rel <= whisker_high_max, max(height.gap.rel)]
    
    whisker_low_min <- db_impact_summary[name == name.selected, whisker_low_min]
    whisker_low.computed <- db_impact[name == name.selected & height.gap.rel >= whisker_low_min, min(height.gap.rel)]
    
    db_impact_summary[name == name.selected, ":="(
      whisker_low = whisker_low.computed,
      whisker_high = whisker_high.computed
    )]
    
  }

  # identify cases with whiskers are out of the box
  db_whisker_info_low <- db_impact_summary[whisker_low < y.min - 0.02, .(name, label = whisker_low)]
  db_whisker_info_high <- db_impact_summary[whisker_high > y.max + 0.02, .(name, label = whisker_high)]

  
  # plot boxplot ----
  
  graphical_abstract <- ggplot(
      data = db_impact, 
      aes(
        x = name,
        y = height.gap.rel * 100
      )
    ) +
    geom_abline(
      slope = 0, 
      intercept = 0,
      color = "red", 
      lwd = 0.2
    ) +
    geom_boxplot(
      outlier.shape = NA,
      lwd = 0.1
    ) + 
    theme_bw() +
    geom_text(
      data = db_impact_summary,
      aes(
        x = name,
        y = 100 * whisker_high + 1,
        label = stand.number
      ),
      size = 0.3 * text.size.main,
      angle = 0,
      nudge_y = 0.5
    ) +
    geom_text(
      data = db_whisker_info_low,
      aes(
        x = name,
        y = 100 * y.min,
        label = paste0(round(100 * label)," %")
      ),
      size = text.size.main / 4,
      angle = 90,
      nudge_y = 0,
      nudge_x = -0.15
    ) +
    geom_text(
      data = db_whisker_info_high,
      aes(
        x = name,
        y = 100 * y.max,
        label = paste0(round(100 * label)," %")
      ),
      size = text.size.main / 4,
      angle = 90,
      nudge_y = 0.5,
      nudge_x = -0.15
    ) +
    labs(
      title = "Comparison of site index between actual recent climate (1950-2020) \nand before climate change reference climate (1891-1920)",
      caption = "The number of stands for each species is above the corresponding boxplot." 
    ) + 
    xlab(NULL) + 
    ylab("Impact of climate change on site index (%)")+
    theme(
      axis.text.x = element_text(angle = 45, size = 4, hjust = 1),
      axis.text.y = element_text(size = 4),
      title = element_text(size = 5),
      plot.caption = element_text(size = 3, hjust = 0),
      panel.grid.major.x = element_blank()
    ) +     
    coord_cartesian(
      ylim = c(100 * y.min, 100 * y.max)
      ) +
    scale_y_continuous(
      breaks = round(seq(-10, 20, 5)),
      minor_breaks = NULL,
      labels = paste0(round(seq(-10, 20, 5)), "%")
    )
  
      
ggsave(
  filename = "graphical_abstract.jpg",
  plot = graphical_abstract ,
  path = dir.fig.tab,
  height = 7, 
  width = 10, 
  units = "cm",
  limitsize = FALSE
)

  
  
```

